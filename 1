if __name__ == "__main__":
    os.makedirs(os.path.dirname(CONFIG_PATH), exist_ok=True)
    os.makedirs(os.path.dirname(USERS_PATH), exist_ok=True)

    # If behind a proxy (nginx/ALB) set OGG_BEHIND_PROXY=1
    if str(os.environ.get("OGG_BEHIND_PROXY", "0")).lower() in ("1","true","yes"):
        # trust one hop for X-Forwarded-Proto / Host so request.is_secure works
        app.wsgi_app = ProxyFix(app.wsgi_app, x_proto=1, x_host=1)

    ensure_initial_admin()

    ssl_ctx = _ssl_context_from_env()
    if ssl_ctx:
        # mark cookies secure when HTTPS is enabled
        app.config["SESSION_COOKIE_SECURE"] = True

    # security & diagnostics
    print(f"* {APP_TITLE} {'https' if ssl_ctx else 'http'}://{LISTEN_HOST}:{LISTEN_PORT}")
    print(f"* Using config: {CONFIG_PATH}")
    print(f"* Users file : {USERS_PATH}")
    try:
        with open(CONFIG_PATH,'r',encoding='utf-8') as f:
            print('* Config head:\n'+''.join(f.readlines()[:30]))
    except Exception as e:
        print(f"* Config read issue: {e}")

    # send HSTS when serving HTTPS (ok if also sent on HTTP)
    @app.after_request
    def _hsts(r):
        r.headers["Strict-Transport-Security"] = "max-age=63072000; includeSubDomains"
        return r

    app.run(host=LISTEN_HOST, port=LISTEN_PORT, ssl_context=ssl_ctx)
